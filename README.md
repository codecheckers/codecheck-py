# codecheck-py

[![Binder](https://mybinder.org/badge_logo.svg)](https://mybinder.org/v2/gh/codecheckers/codecheck-py/main?labpath=.codecheck/codecheck.ipynb)

Python-based template for writing [CODECHECK](https://codecheck.org.uk)
certificates.

Note that this is an **alpha version**, please report any issues in the
[issue tracker](https://github.com/codecheckers/codecheck-py/issues).

## Try it Online

**ğŸš€ Launch on Binder**: Click the badge above to try this template in your browser without installing anything! The Binder environment includes all dependencies and opens an interactive notebook to explore the template.

### What You Can Do on Binder

- **Explore the template**: Run the certificate generation notebook
- **Test validation**: Try the validation system with example data
- **Experiment**: Modify code and see results immediately
- **Learn**: Follow the workflow without local setup

**Note**: Binder environments are temporary and reset when idle. For actual CODECHECK work, clone the repository locally.

## Usage

The files in this repository are meant to be placed into the `codecheck`
directory of a repository that has been forked for a CODECHECK. The codechecker
needs to fill out the jupyter notebook `codecheck.ipynb` which automatically
generates some boilerplate content based on the `codecheck.yml` file and
includes figures and a summary of CSV files regenerated by the codechecker (see
below and comments in `codecheck.py`).

To generate a report from the notebook (which by default hides all the code used
for the automatic content generation), run:

```bash
jupyter nbconvert --to pdf --no-input --no-prompt --execute --LatexExporter.template_file nbconvert_template.tex.j2 codecheck.ipynb
```

The `environment.yml` file defines a [conda](https://coda.io) environment that
can be used to install all the necessary packages:

```bash
conda env create -f environment.yml
conda activate codecheck-env
```

The (optional) `nbconvert_template.tex.j2` template overrides some of the
default nbconvert settings, in particular by reducing the font size and the
margins a bit, and enabling line breaks in verbatim output (useful e.g. when
including command line output/log files in the report).

This template makes a few assumptions:

* The main directory needs to have a `codecheck.yml` (i.e. `../codecheck.yml`
  from the point of view of the jupyter notebook) file with all the required
  information stated in the
  [configuration file specification](https://codecheck.org.uk/spec/config/1.0/).
* Files referenced in the *manifest* of the configuration file are reproduced
  in an `outputs` subdirectory of `codecheck`. The remaining directory structure
  needs to be reproduced in this directory. For example, if the manifest
  references a file `figures/image.png`, the reproduced image needs to be placed
  into `codecheck/outputs/figures/image.png`.

For an example use of this template in a CODECHECK, see
<https://github.com/codecheckers/causality-review/>

## Repository Structure

When using this template for a CODECHECK, your repository should follow this structure:

```
repository-root/
â”œâ”€â”€ codecheck.yml                    # Configuration file (at root level)
â”œâ”€â”€ figures/                         # Original figures from paper
â”‚   â”œâ”€â”€ plot1.png
â”‚   â””â”€â”€ plot2.pdf
â”œâ”€â”€ data/                           # Original data files
â”‚   â””â”€â”€ results.csv
â”œâ”€â”€ code/                           # Original code to reproduce results
â”‚   â”œâ”€â”€ analysis.py
â”‚   â””â”€â”€ generate_figures.R
â””â”€â”€ codecheck/                      # CODECHECK materials (this template)
    â”œâ”€â”€ codecheck.py                # Helper module
    â”œâ”€â”€ codecheck.ipynb             # Certificate notebook
    â”œâ”€â”€ validation.py               # Validation module (NEW)
    â”œâ”€â”€ validation_config.py        # Validation configuration (NEW)
    â”œâ”€â”€ manifest.py                 # Manifest processing (NEW)
    â”œâ”€â”€ environment.yml             # Conda environment
    â”œâ”€â”€ nbconvert_template.tex.j2   # LaTeX template
    â”œâ”€â”€ codecheck_logo.png          # CODECHECK logo
    â”œâ”€â”€ codecheck.pdf               # Generated certificate (output)
    â””â”€â”€ outputs/                    # Reproduced files from manifest
        â”œâ”€â”€ figures/
        â”‚   â”œâ”€â”€ plot1.png           # Reproduced version
        â”‚   â””â”€â”€ plot2.pdf           # Reproduced version
        â””â”€â”€ data/
            â””â”€â”€ results.csv         # Reproduced version
```

### Key Points:

1. **`codecheck.yml`** is at the repository root, not inside the `codecheck/` directory
2. **Original files** (from the paper) live in the main repository structure
3. **Reproduced files** (regenerated by the codechecker) go in `codecheck/outputs/`
4. The **directory structure** within `outputs/` should mirror the paths specified in the manifest
5. File paths in `codecheck.yml` manifest are relative to the repository root

### Example Workflow

```bash
# 1. Fork the repository to be checked
# 2. Copy this template into a codecheck/ directory
# 3. Create codecheck.yml at root with manifest entries
# 4. Run the authors' code to reproduce outputs
# 5. Copy reproduced files to codecheck/outputs/
cp figures/plot1.png codecheck/outputs/figures/plot1.png
cp data/results.csv codecheck/outputs/data/results.csv

# 6. Fill out codecheck.ipynb with your notes
# 7. Generate the certificate PDF
cd codecheck
jupyter nbconvert --to pdf --no-input --no-prompt --execute \
  --LatexExporter.template_file nbconvert_template.tex.j2 codecheck.ipynb
```

## Validation Features

This template now includes comprehensive validation features to check your `codecheck.yml` configuration before generating the certificate. Validation helps catch errors early and ensures your CODECHECK meets the specification.

### Quick Start with Validation

```python
from codecheck import Codecheck

# Initialize with validation enabled
check = Codecheck(validate=True, strict=False)

# Or validate manually
check = Codecheck()
passed, issues = check.validate(
    check_manifest=True,
    check_register=True,  # Check GitHub register (default: True)
    strict=False
)
check.validation_report()
```

### Validation Checks Performed

The validation system performs the following checks on your `codecheck.yml` file:

#### 1. **YAML Syntax Validation**

- âœ“ Valid YAML structure
- âœ“ Proper indentation
- âœ“ No syntax errors
- âœ“ File is readable and parseable

#### 2. **Field Completeness**

- **Mandatory fields** (must be present):
  - `manifest` - List of reproduced files
  - `codechecker` - Name and ORCID of checker
  - `report` - DOI or URL of certificate report

- **Recommended fields** (warnings if missing):
  - `version` - Config specification version
  - `paper` - Paper metadata (title, authors, reference)
  - `repository` - Code repository URL
  - `check_time` - When the check was performed
  - `certificate` - Certificate ID (YYYY-NNN format)

- **Optional fields**:
  - `summary` - Summary of findings
  - `source` - Additional source information

#### 3. **Placeholder Detection**

- âœ“ Detects common placeholder patterns:
  - "FIXME", "TODO", "template", "example"
  - "XXXXX", "placeholder"
- âœ“ Flags incomplete configuration values
- âœ“ Helps ensure all fields are filled in

#### 4. **Certificate ID Format**

- âœ“ Format: `YYYY-NNN` (e.g., `2023-001`)
- âœ“ Year must be 4 digits
- âœ“ Number must be 3 digits
- âœ“ Detects placeholder certificates:
  - `YYYY-001`, `0000-001`, `9999-001`

#### 5. **Report DOI/URL Validation**

- âœ“ Must be a valid URL or DOI
- âœ“ Detects placeholder DOIs:
  - `10.5281/zenodo.XXXXXX`
  - URLs containing "placeholder" or "example"

#### 6. **ORCID Format Validation**

- âœ“ Format: `0000-0000-0000-0000` (or ending in X)
- âœ“ Validates for all authors
- âœ“ Validates for codechecker(s)
- âœ“ Detects invalid ORCID patterns

#### 7. **Date/Time Format Validation**

- âœ“ `check_time` must be ISO 8601 format
- âœ“ Format: `YYYY-MM-DDTHH:MM:SS`
- âœ“ Example: `2023-11-15T14:30:00`

#### 8. **Paper Structure Validation**

- âœ“ Paper section must be a dictionary
- âœ“ Must contain: `title`, `authors`, `reference`
- âœ“ Authors must be a list
- âœ“ Each author must have `name` field
- âœ“ ORCID recommended for each author

#### 9. **Codechecker Structure Validation**

- âœ“ Must be a dictionary
- âœ“ Must contain `name` field
- âœ“ ORCID strongly recommended

#### 10. **Manifest Structure Validation**

- âœ“ Must be a list (not empty)
- âœ“ Each entry must be a dictionary
- âœ“ Each entry must have `file` field
- âœ“ `comment` field is optional but recommended

#### 11. **Manifest File Existence**

- âœ“ Checks all files exist in `codecheck/outputs/`
- âœ“ Reports missing files
- âœ“ Validates paths are safe (no path traversal)

#### 12. **GitHub Register Issue Verification** (NEW)

- âœ“ Checks if a GitHub issue exists in [codecheckers/register](https://github.com/codecheckers/register)
- âœ“ Searches for issue with certificate ID in title
- **ERROR** if no matching issue found
- **WARNING** if issue is closed
- **WARNING** if issue is unassigned
- âœ“ Can be disabled with `check_register=False`
- âœ“ Gracefully handles network errors (warns but doesn't fail)

### Validation Modes

**Non-strict mode** (default):

- Reports errors and warnings
- Only fails on errors
- Allows generation with warnings

**Strict mode**:

- Treats warnings as failures
- Ensures complete configuration
- Use for final validation

### Example Validation Output

```txt
## âŒ Errors (2)

- **manifest**: Missing 2 file(s) in outputs/: figures/plot1.png, data/results.csv
  - *Suggestion*: Copy all manifest files to codecheck/outputs/ directory

- **codechecker.name**: Codechecker name is missing
  - *Suggestion*: Add name field for codechecker

## âš ï¸  Warnings (3)

- **certificate**: Certificate ID 'YYYY-001' appears to be a placeholder
  - *Suggestion*: Replace with actual certificate ID (format: YYYY-NNN)

- **paper.authors[0].ORCID**: Author 1 ORCID is missing
  - *Suggestion*: Add ORCID for complete author information

- **summary**: Recommended field 'summary' is missing
  - *Suggestion*: Consider adding 'summary' for a complete certificate
```

### Disabling Register Checks

If you need to validate without checking the GitHub register (e.g., for offline work or testing):

```python
# Disable register check
passed, issues = check.validate(
    check_manifest=True,
    check_register=False,  # Skip GitHub API call
    strict=False
)
```

## Testing

This template includes a comprehensive test suite. To run tests:

```bash
# Install test dependencies
conda env create -f environment.yml
conda activate codecheck-env

# Run tests
pytest tests/ -v

# Run with coverage
pytest tests/ -v --cov=. --cov-report=term-missing
```

The test suite includes:

- 50+ unit tests for validation functions
- 14 tests for GitHub register issue verification
- Integration tests for the complete workflow
- Tests with various invalid configurations
- Fixture-based testing with example configurations
- Mock-based testing for GitHub API interactions

## Continuous Integration

Tests run automatically on GitHub Actions for every push to the main branch. See `.github/workflows/test.yml` for the CI configuration.

## License

This repository is licensed under MIT License, see the LICENSE file for details.
